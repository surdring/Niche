

### ğŸ› ï¸ é€šç”¨åŸå­ä»»åŠ¡æ‰§è¡Œæ¨¡æ¿ (Universal Task Prompt)

**ä½¿ç”¨è¯´æ˜**ï¼šå½“éœ€è¦ AI æ‰§è¡Œ `tasks.md` ä¸­æŸä¸ªå…·ä½“çš„å­ä»»åŠ¡ï¼ˆä¾‹å¦‚ Task 6.2ï¼‰æ—¶ï¼Œè¯·å¤åˆ¶æ­¤æ¨¡æ¿ï¼Œå¹¶æ›¿æ¢ `[ ]` ä¸­çš„å†…å®¹ã€‚

```markdown
# Context
You are the Lead Engineer for the Vertical AI Framework.
We are currently executing **[Phase X: é˜¶æ®µåç§°]**.
Your immediate goal is to complete **Task [Task ID]: [ä»»åŠ¡æè¿°]**.

# References
1. **Design Specs**: Refer to `design.md` section **[ç›¸å…³è®¾è®¡ç« èŠ‚ï¼Œå¦‚ "3. RAG ç®¡é“"]**.
2. **Interfaces**: Implement strictly according to interface **[æ¥å£åç§°ï¼Œå¦‚ "IVectorStore"]**.
3. **Correctness Property**: You MUST verify **Property [å±æ€§ç¼–å·]** ([å±æ€§åç§°]) defined in `design.md`.

# Instructions

## Step 1: Implementation
- Create/Edit file: `[ç›®æ ‡æ–‡ä»¶è·¯å¾„]`.
- Implement the logic using **TypeScript** and **Zod**.
- **Constraint**: Ensure strict type safety. Do not use `any`.
- **Constraint**: If specific error codes/types are defined in `design.md` (Error Handling section), use them.

## Step 2: Property-Based Testing
- Create/Edit test file: `tests/property/[æµ‹è¯•æ–‡ä»¶å].test.ts`.
- Use `fast-check` and `vitest`.
- **Goal**: Implement the test for **Property [å±æ€§ç¼–å·]**.
- Logic:
  1. Define the Arbitrary (generator) for input data strictly matching the Zod schema.
  2. Run the function/class method.
  3. Assert the invariant (the "Property") holds true.
  - *Example invariant*: `result.startOffset < result.endOffset` OR `decode(encode(x)) === x`.

# Checklist
- [ ] Code compiles without linting errors.
- [ ] Interface matches `design.md` exactly.
- [ ] At least one Property Test passes 100 iterations.

Please generate the implementation code and the property test code now.
```

---

### ğŸ” ä»£ç å®¡æŸ¥ä¸é‡æ„æç¤ºè¯ (Code Review & Refactor Prompt)

**ä½¿ç”¨è¯´æ˜**ï¼šå½“ AI å®Œæˆä¸€ä¸ªé˜¶æ®µæˆ–ä¸€ä¸ªå¤æ‚æ¨¡å—åï¼Œä½¿ç”¨æ­¤æç¤ºè¯è®©å®ƒè‡ªæˆ‘å®¡æŸ¥ï¼Œç¡®ä¿æ²¡æœ‰å¼•å…¥æŠ€æœ¯å€ºåŠ¡ã€‚

```markdown
# Context
You have just completed a set of tasks. Now act as a **QA Engineer and Security Specialist**.
Review the current codebase (specifically `packages/core` and `apps/api`).

# Review Objectives

## 1. Design Compliance Check
- Verify that all exported functions/classes match the interfaces in `design.md`.
- Check if **Zod Schemas** are used for ALL external inputs (API inputs, Tool arguments, Config loading).

## 2. Correctness Property Audit
- Look at `design.md` -> "Correctness Properties".
- Are there any implemented features that lack a corresponding Property Test?
- *Action*: If yes, list them and propose the test logic.

## 3. Security & Safety (Guardrails)
- **Injection**: Are variables in SQL/Vector DB queries properly parameterized?
- **PII**: Is there any logging statement that might accidentally log raw user input before PII redaction?
- **Error Handling**: Are we leaking stack traces to the API response? (Ensure `Fastify` error handler masks internal errors).

## 4. Performance (Async/Await)
- Check for "await inside loop" patterns. Suggest `Promise.all` where applicable.
- Check if high-latency operations (DB writes, Telemetry) are blocking the main response thread (should use `event.waitUntil` pattern or fire-and-forget).

# Output
Provide a concise bulleted list of issues found (if any) and a refactoring plan. If the code is solid, verify clearly why it meets the criteria.
```

---

### ğŸ©¹ Bug ä¿®å¤ä¸“ç”¨æç¤ºè¯ (Bug Fix Prompt)

**ä½¿ç”¨è¯´æ˜**ï¼šå½“æµ‹è¯•å¤±è´¥æˆ–å‡ºç°è¿è¡Œæ—¶é”™è¯¯æ—¶ã€‚

```markdown
# Context
We encountered a bug/failure during **Task [Task ID]**.

# Error Info
- **Test File**: `[æµ‹è¯•æ–‡ä»¶å]`
- **Property Violated**: Property [ç¼–å·] - [åç§°]
- **Error Message**:
```text
[ç²˜è´´é”™è¯¯å †æ ˆæˆ– Vitest è¾“å‡º]
```

# Analysis Request
1. **Root Cause**: Analyze why the code failed the property test. Was the logic wrong, or was the generated test case edge-case valid but unhandled?
2. **Minimal Reproduction**: Create a minimal reproduction case (a standard `it(...)` test) that fails deterministically with the counter-example provided by `fast-check`.
3. **Fix**: Propose the code fix.
4. **Verification**: Confirm the fix passes both the new unit test and the original property test.
```

---

### ğŸ§ª è¡¥å……ï¼šé’ˆå¯¹å¤æ‚æ¨¡å—çš„æ·±åº¦æç¤ºè¯

é’ˆå¯¹ `design.md` ä¸­å‡ ä¸ªç‰¹åˆ«å¤æ‚çš„é€»è¾‘ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹ä¸“ç”¨æç¤ºè¯æ›¿æ¢ `tasks.md` ä¸­ç®€å•çš„æè¿°ã€‚

#### 1. é’ˆå¯¹ Task 6.2 (Chunker) çš„æ·±åº¦æç¤ºè¯
> è¿™ä¸ªæ¨¡å—å¾ˆå®¹æ˜“å‡ºé”™ï¼ˆåç§»é‡è®¡ç®—ï¼‰ï¼Œéœ€è¦ç‰¹åˆ«å¼ºè°ƒã€‚

```markdown
# Task: Implement Document Chunker
# Focus: Property 2 (Document Chunking Integrity)

Implement `packages/core/src/services/chunker.ts`.
You must implement `SemanticChunker` and `SlidingWindowChunker`.

**CRITICAL REQUIREMENT**:
You must track `startOffset` and `endOffset` for every chunk relative to the original text.
- `originalText.slice(chunk.startOffset, chunk.endOffset)` MUST equal `chunk.content` exactly.
- There must be NO gaps between chunks if `overlap` is 0.
- Verify this logic using `fast-check` by generating random strings, chunking them, and verifying the slice reconstruction matches the content.
```

#### 2. é’ˆå¯¹ Task 19.1 (Chat API & Stream) çš„æ·±åº¦æç¤ºè¯
> éœ€è¦ç¡®ä¿åè®®åˆè§„æ€§ï¼Œè¿™æ˜¯å‰ç«¯èƒ½æ­£å¸¸å·¥ä½œçš„å…³é”®ã€‚

```markdown
# Task: Implement Chat API Endpoint
# Focus: Property 14 & 15 (Stream Protocol Compliance)

Implement `apps/api/src/routes/chat.ts` and the `StreamHandler`.

**PROTOCOL SPECS**:
You must strictly follow **Vercel AI Data Stream Protocol (v1)**.
- Text: `0:"hello"`
- Data/Citations: `2:[{"citation":...}]` (Note: verify the exact digit for data parts in latest SDK)
- Error: `e:{"error":"..."}`

**Constraints**:
- Set Header: `X-Vercel-AI-Data-Stream: v1`.
- Do NOT buffer the entire response. Use strict streaming.
- If an error occurs *after* the stream starts, you MUST send an Error Chunk (`e:...`), do not just close the connection or throw a JSON error (which would break the stream syntax).
```

#### 3. é’ˆå¯¹ Task 11 (Structured Output) çš„æ·±åº¦æç¤ºè¯
> ç¡®ä¿é‡è¯•æœºåˆ¶æœ‰æ•ˆã€‚

```markdown
# Task: Implement Structured Output with Auto-Correction
# Focus: Property 17 (Auto-fix)

Implement the wrapper for `generateObject` in `packages/core`.

**Logic**:
1. Try to generate object.
2. If `ZodError` occurs:
   - Catch the error.
   - Construct a new "User Message" containing the validation error details.
   - Append to history and request the model to "fix the JSON format matching the schema".
   - Retry (up to `maxRetries`).
3. If all retries fail, throw a typed `StructureValidationError`.

**Testing**:
Mock the LanguageModel to intentionally return bad JSON on the first 2 calls, then good JSON on the 3rd. Verify the wrapper handles this transparency.
```