### 1. 遵循的结构模板

每个任务的 Prompt 必须包含以下完整结构：

```markdown
### Task T# - 任务标题

\`\`\`markdown
# Context
你是 Niche/Study Copilot 的 负责落地与验收的工程师。
你正在执行 [Phase/类别]。
你的目标是完成任务 T#：[任务标题]。

# 全局约束与标准
- TypeScript Strict；禁止 any。
- 所有契约必须以 Zod Schema 为单一事实源（z.infer）。
- 错误 message 使用英文。
- [补充该任务特有的约束]

# References
- requirements: specs/study-copilot/requirements.md (R#, R#)
- tasks: specs/study-copilot/tasks.md (T#)
- [补充相关设计文档]

# Execution Plan
[详细的分步执行计划，至少 3-5 个步骤]

1) [步骤 1]
- Scope: [范围说明]
- Files（建议）: [涉及的文件路径]
- Requirements: [关键要求]

2) [步骤 2]
...

# Verification
- 自动化断言（至少覆盖以下断言）：
  - [断言 1]：[具体验证点]
  - [断言 2]：[具体验证点]
  - [断言 3]：[具体验证点]

# Checklist
- [ ] [关键交付物 1]
- [ ] [关键交付物 2]
- [ ] [自动化测试覆盖点]

# Output
- 输出（强制包含以下内容）：
  - [具体产物 1]
  - [具体产物 2]
  - [测试/验证方式]
\`\`\`
```

### 2. 关键要求

#### A. Execution Plan 必须具体

**禁止**：泛泛而谈（例如"实现 OCR 功能"）

**要求**：
- 明确技术选型建议（例如"选择 Tesseract.js 或 Google Vision API，优先可替换的 OCR Adapter 抽象"）
- 明确与现有模块的对接点（例如"OCR 输出 -> 进入 T23 的数据处理管道"）
- 明确错误与降级策略（例如"OCR 失败/低置信度：返回可解释错误，提示用户重试"）

#### B. Verification 必须可自动化

**禁止**：仅"手工目测"或"端到端演示"

**要求**：
- 至少 3 条可自动化断言（单元/集成/契约/E2E 任一）
- 明确测试数据/Mock 策略（例如"使用 mock OCR provider 返回固定文本"）
- 明确失败场景覆盖（例如"OCR 超时 -> 返回 PROVIDER_TIMEOUT 错误"）

#### C. Checklist 必须可验收

- 明确失败降级路径（例如" 必须是可明确判断"完成/未完成"的交付物
- 必须包含至少 1 条自动化测试覆盖点

#### D. 依赖关系与风险评估

- 明确前置依赖（例如"依赖 T23 数据处理管道已落地"）
- 明确是否引入新依赖/新服务（例如"需引入 Tesseract.js 或等价 OCR 服务"）
- 明确高风险点与回滚策略（例如"OCR 服务不可用 -> 降级为手动输入模式"）

### 3. 特殊任务类型的补充要求

#### 多模态输入类（T22, T24）

- 必须明确支持的输入格式与大小限制
- 必须明确模型选择策略（例如"图片 -> GPT-4V，音频 -> Whisper"）
- 必须明确失败降级路径（例如"格式不支持 -> 返回可解释错误 + 支持格式列表"）

#### 数据处理类（T23, T24, T40）

- 必须明确输入/输出契约（Zod Schema）
- 必须明确幂等性与可重复性要求（例如"同输入重复处理结果一致"）
- 必须明确 PII 脱敏规则（例如"邮箱 -> [email]，手机 -> [phone]"）

#### 架构扩展类（T25, T26, T27）

- 必须明确接口定义与生命周期
- 必须提供至少 1 个示例实现（例如"示例插件：注册自定义 Tool"）
- 必须明确向后兼容策略（例如"插件 API 只增不改"）

#### Research Copilot 扩展类（T33-T45）

- 必须明确与 Study Copilot MVP 的差异点
- 必须明确引用/证据链的契约变更（例如"Citation 补充 page/coordinates 字段"）

- 必须明确合规边界（例如"snippet 返回需遵循版权策略"）

## 生成流程

### Step 1: 分析任务依赖与现状

- 检查 `specs/study-copilot/tasks.md` 中该任务的依赖关系
- 检查 `specs/study-copilot/requirements.md` 中关联的需求（R#）
- 评估当前工程现状是否满足前置条件

### Step 2: 设计 Execution Plan
, T10, T12）
- 至少 3-5 个分步骤，每步骤包含 Scope/Files/Requirements
- 明确技术选型建议与对接点

### Step 3: 设计 Verification

- 至少 3 条可自动化断言
- 覆盖 Happy Path + 至少 2 个错误分支
- 明确测试数据/Mock 策略

### Step 4: 补充 Checklist 与 Output

- Checklist：可验收的交付物清单
- Output：具体产物（代码/文档/测试）+ 验证方式

### Step 5: 风险评估与回滚策略

- 识别高风险点（例如"新依赖引入"、"契约变更"）
- 提供回滚策略（例如"功能开关降级"、"版本回退"）

## 示例对比

### ❌ 不合格的 Backlog Prompt（过于简略）

```markdown
### Task T24 - OCR 支持

# Execution Plan
1) 选择 OCR 方案
2) 摄入路径对接
3) 错误与降级

# Verification
- 至少 1 个图片样例可 OCR
```

### ✅ 合格的 Backlog Prompt（与 MVP 同等详细度）

```markdown
### Task T24 - OCR 支持（图片与扫描 PDF）

\`\`\`markdown
# Context
你是 Niche/Study Copilot 的 负责落地与验收的工程师。
你正在执行 Backlog 扩展任务。
你的目标是完成任务 T24：OCR 支持（图片与扫描 PDF）。

# 全局约束与标准
- TypeScript Strict；禁止 any。
- OCR 输出必须经过 Zod 校验（编码/格式/置信度）。
- 错误 message 使用英文。
- OCR Adapter 必须可替换（便于后续切换供应商/本地模型）。

# References
- requirements: specs/study-copilot/requirements.md (R19)
- tasks: specs/study-copilot/tasks.md (T24)
- design: specs/study-copilot/design/design-backend.md（数据处理管道）

# Execution Plan

1) 选择 OCR 方案并实现 Adapter 抽象
- Scope:
  - 技术选型：Tesseract.js（本地）或 Google Vision API（云端），优先可替换的 OCR Adapter 抽象
  - 接口定义：`OCRAdapter.extract(input: Buffer | File) => Promise<OCRResult>`
- Files（建议）:
  - packages/core/src/adapters/ocr/OCRAdapter.ts（抽象接口）
  - packages/core/src/adapters/ocr/TesseractAdapter.ts（示例实现）
- Requirements:
  - 支持图片格式：PNG/JPEG/WebP
  - 支持扫描 PDF（先转图片再 OCR）
  - 返回结构化结果：`{ text: string, confidence: number, language?: string }`

2) 对接 T23 数据处理管道
- Scope:
  - OCR 输出 -> 进入 T23 的清洗/脱敏/增强流水线
  - 低置信度文本标记为"需人工复核"
- Files（建议）:
  - packages/core/src/pipelines/ingestion.ts（摄入入口）
- Requirements:
  - OCR 结果必须携带来源元数据（originalFile/pageNumber/confidence）
  - 置信度 < 0.7：标记 `status=needs_review`

3) 错误与降级策略
- Scope:
  - OCR 失败：返回 `OCR_FAILED` 错误（含可重试建议）
  - 低置信度：返回 `OCR_LOW_CONFIDENCE` 警告（含人工复核提示）
  - 格式不支持：返回 `UNSUPPORTED_FORMAT` 错误（含支持格式列表）
- Files（建议）:
  - packages/core/src/contracts/error.ts（补充错误码）

4) 可观测性
- Scope:
  - 记录 OCR 耗时、置信度分布、失败率
  - 与 requestId 关联（便于排查）
- Requirements:
  - 日志必含：requestId/fileId/ocrProvider/confidence/duration

# Verification
- 自动化断言（至少覆盖以下断言）：
  - 单元测试：mock OCR provider 返回固定文本 -> 断言可被 `OCRResult` schema parse
  - 集成测试：给定 1 个图片样例（PNG）-> OCR 输出非空且 confidence > 0
  - 集成测试：给定 1 个扫描 PDF 样例 -> 每页可产出文本且携带 pageNumber
  - 错误分支：OCR 超时/失败 -> 返回 `OCR_FAILED` 错误（含 requestId + retryable=true）
  - 错误分支：上传不支持格式（例如 .txt）-> 返回 `UNSUPPORTED_FORMAT` 错误（含支持格式列表）
  - 降级分支：confidence < 0.7 -> 标记 `status=needs_review` 且可在 UI 展示警告

# Checklist
- [ ] 实现 OCRAdapter 抽象接口（可替换）
- [ ] 实现至少 1 个 OCR provider（Tesseract.js 或等价）
- [ ] 对接 T23 数据处理管道（OCR 输出 -> 清洗/脱敏）
- [ ] 支持图片格式：PNG/JPEG/WebP
- [ ] 支持扫描 PDF（多页）
- [ ] 错误与降级：OCR_FAILED / OCR_LOW_CONFIDENCE / UNSUPPORTED_FORMAT
- [ ] 可观测性：日志含 requestId/confidence/duration
- [ ] 单元测试：mock provider + schema parse
- [ ] 集成测试：图片样例 + PDF 样例 + 错误分支 + 降级分支

# Output
- 输出（强制包含以下内容）：
  - OCRAdapter 接口定义（TypeScript）
  - 至少 1 个 provider 实现（Tesseract.js 或等价）
  - OCRResult schema（Zod）
  - 错误码定义（OCR_FAILED / OCR_LOW_CONFIDENCE / UNSUPPORTED_FORMAT）
  - 测试用例清单（单元 + 集成，至少 6 条断言）
  - 示例日志输出（脱敏）
  - 依赖清单（新增的 npm 包）
  - 回滚策略：OCR 服务不可用 -> 降级为"手动输入模式"或"跳过 OCR 步骤"
\`\`\`
```