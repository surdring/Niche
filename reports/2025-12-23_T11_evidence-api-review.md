# ä»£ç å®¡æŸ¥æŠ¥å‘Š - T11 Evidence APIï¼šcitationId -> è¯æ®å±•ç¤ºæ•°æ®

## å®¡æŸ¥æ¦‚è¦
- å®¡æŸ¥æ—¶é—´ï¼š2025-12-23
- ä»»åŠ¡ç¼–å·ï¼šT11
- å®¡æŸ¥èŒƒå›´ï¼šä»£ç /æµ‹è¯•/å¥‘çº¦/éš”ç¦»/é™çº§ç­–ç•¥
- å®¡æŸ¥ç»“æœï¼š**é€šè¿‡ âœ…**

## é—®é¢˜æ¸…å•

### ğŸ”´ é˜»æ–­æ€§é—®é¢˜ï¼ˆ0ï¼‰
æ— é˜»æ–­æ€§é—®é¢˜ã€‚

### ğŸŸ  ä¸¥é‡é—®é¢˜ï¼ˆ0ï¼‰
æ— ä¸¥é‡é—®é¢˜ã€‚

### ğŸŸ¡ ä¸€èˆ¬é—®é¢˜ï¼ˆ0ï¼‰
æ— ä¸€èˆ¬é—®é¢˜ã€‚

### ğŸŸ¢ ä¼˜åŒ–å»ºè®®ï¼ˆ2ï¼‰

1. **æµ‹è¯•è¦†ç›–å¯å¢å¼º**
   - ä½ç½®ï¼šapps/api/src/evidence.test.ts
   - åŸå› ï¼šå½“å‰ä»…æœ‰ 2 ä¸ªé›†æˆæµ‹è¯•ï¼Œå¯è¡¥å……æ›´å¤šè¾¹ç•Œåœºæ™¯
   - å½±å“ï¼šè¾¹ç•Œåœºæ™¯è¦†ç›–ä¸è¶³
   - å»ºè®®ï¼šè¡¥å……ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹
     - æ— æ•ˆçš„ citationId æ ¼å¼ï¼ˆéå­—ç¬¦ä¸²ã€ç©ºå­—ç¬¦ä¸²ï¼‰
     - ç¼ºå¤± tenantId çš„åœºæ™¯ï¼ˆè™½ç„¶åœ¨ onRequest hook ä¸­å·²æ‹¦æˆªï¼Œä½†å¯è¡¥å……å•å…ƒæµ‹è¯•ï¼‰
     - ragflow citationId çš„ tenantId ä¸åŒ¹é…åœºæ™¯ï¼ˆå½“å‰ä»…æµ‹è¯•äº† projectId ä¸åŒ¹é…ï¼‰

2. **æ–‡æ¡£å¯è¡¥å……**
   - ä½ç½®ï¼špackages/core/src/services/evidence-service.ts
   - åŸå› ï¼šæ ¸å¿ƒæœåŠ¡å‡½æ•°ç¼ºå°‘ JSDoc æ³¨é‡Š
   - å½±å“ï¼šä»£ç å¯ç»´æŠ¤æ€§
   - å»ºè®®ï¼šä¸º `getEvidenceByCitationId` æ·»åŠ  JSDocï¼Œè¯´æ˜å‚æ•°ã€è¿”å›å€¼ã€é”™è¯¯åœºæ™¯

## å®¡æŸ¥ç»´åº¦è¯¦æƒ…

### A. ä»£ç è´¨é‡å®¡æŸ¥

#### A1. TypeScript ä¸¥æ ¼æ€§
- [x] **ç¦æ­¢ `any`**ï¼šâœ… æœªå‘ç°ä»»ä½• `any` ç±»å‹
- [x] **ç±»å‹å®Œæ•´æ€§**ï¼šâœ… æ‰€æœ‰å‡½æ•°å‚æ•°ã€è¿”å›å€¼å‡æœ‰æ˜ç¡®ç±»å‹
- [x] **ç±»å‹å®‰å…¨**ï¼šâœ… æœªå‘ç°ç±»å‹æ–­è¨€æ»¥ç”¨
- [x] **æ³›å‹ä½¿ç”¨**ï¼šâœ… æ³›å‹çº¦æŸåˆç†

#### A2. Zod æ ¡éªŒ
- [x] **è¾“å…¥æ ¡éªŒ**ï¼šâœ… citationId ç»è¿‡ `CitationIdSchema` æ ¡éªŒ
- [x] **è¾“å‡ºæ ¡éªŒ**ï¼šâœ… Evidence è¾“å‡ºç»è¿‡ `EvidenceSchema.parse`
- [x] **Schema ä¸€è‡´æ€§**ï¼šâœ… ä½¿ç”¨ `z.infer` ä¿è¯ç±»å‹ä¸€è‡´
- [x] **é”™è¯¯å¤„ç†**ï¼šâœ… æ ¡éªŒå¤±è´¥è¿”å› `VALIDATION_ERROR`ï¼Œmessage ä¸ºè‹±æ–‡

#### A3. é”™è¯¯å¤„ç†
- [x] **é”™è¯¯ç å®šä¹‰**ï¼šâœ… ä½¿ç”¨ `AUTH_ERROR`ã€`VALIDATION_ERROR`
- [x] **é”™è¯¯æ¶ˆæ¯**ï¼šâœ… æ‰€æœ‰é”™è¯¯æ¶ˆæ¯ä½¿ç”¨è‹±æ–‡ä¸”åŒ…å« requestId
- [x] **é”™è¯¯ä¼ æ’­**ï¼šâœ… é”™è¯¯æ­£ç¡®ä¼ æ’­åˆ° API å±‚
- [x] **é™çº§ç­–ç•¥**ï¼šâœ… ä¸å¯å›æºæ—¶è¿”å› `status=unavailable`

#### A4. ä»£ç é£æ ¼ä¸å¯ç»´æŠ¤æ€§
- [x] **å‘½åè§„èŒƒ**ï¼šâœ… å˜é‡ã€å‡½æ•°å‘½åæ¸…æ™°ä¸€è‡´
- [x] **å‡½æ•°å¤æ‚åº¦**ï¼šâœ… `getEvidenceByCitationId` çº¦ 60 è¡Œï¼Œé€»è¾‘æ¸…æ™°
- [x] **é‡å¤ä»£ç **ï¼šâœ… é”™è¯¯åˆ›å»ºå‡½æ•°å·²æŠ½å–ï¼ˆ`createAuthError`ã€`createValidationError`ï¼‰
- [x] **æ³¨é‡Šè´¨é‡**ï¼šğŸŸ¡ æ ¸å¿ƒå‡½æ•°ç¼ºå°‘ JSDocï¼ˆè§ä¼˜åŒ–å»ºè®® 2ï¼‰

#### A5. å®‰å…¨æ€§
- [x] **è¾“å…¥éªŒè¯**ï¼šâœ… citationId ç»è¿‡ Zod æ ¡éªŒ
- [x] **æ•æ„Ÿæ•°æ®**ï¼šâœ… æ— æ•æ„Ÿæ•°æ®æ³„éœ²
- [x] **æƒé™æ£€æŸ¥**ï¼šâœ… tenantId/projectId éš”ç¦»æ ¡éªŒå®Œæ•´
- [x] **ä¾èµ–å®‰å…¨**ï¼šâœ… æ— æ–°å¢ä¾èµ–

### B. å¥‘çº¦ä¸€è‡´æ€§å®¡æŸ¥

#### B1. å¥‘çº¦å®šä¹‰å®Œæ•´æ€§
- [x] **Schema å®šä¹‰**ï¼šâœ… `EvidenceSchema` å®šä¹‰å®Œæ•´ï¼ˆå¤ç”¨ `CitationSchema`ï¼‰
- [x] **æ–‡æ¡£åŒæ­¥**ï¼šâœ… ä¸ `design-contracts.md` ä¸€è‡´
- [x] **ç‰ˆæœ¬ç®¡ç†**ï¼šâœ… å¥‘çº¦æœªç ´åæ€§å˜æ›´
- [x] **ç¤ºä¾‹æ•°æ®**ï¼šâœ… æµ‹è¯•ä¸­æä¾›äº†ç¤ºä¾‹æ•°æ®

#### B2. å¥‘çº¦ä½¿ç”¨ä¸€è‡´æ€§
- [x] **è¾“å…¥å¥‘çº¦**ï¼šâœ… API ä¸¥æ ¼æŒ‰ç…§å¥‘çº¦æ¥æ”¶ citationIdï¼ˆquerystringï¼‰
- [x] **è¾“å‡ºå¥‘çº¦**ï¼šâœ… API ä¸¥æ ¼æŒ‰ç…§ `EvidenceSchema` è¿”å›
- [x] **é”™è¯¯å¥‘çº¦**ï¼šâœ… é”™è¯¯è¿”å›ç¬¦åˆ `AppErrorSchema`

#### B3. è·¨æ¨¡å—å¥‘çº¦
- [x] **æ¥å£å¯¹æ¥**ï¼šâœ… `CitationRepo` æ¥å£å®šä¹‰æ¸…æ™°
- [x] **æ•°æ®æµ**ï¼šâœ… citationId -> repo -> evidence æµè½¬ä¿æŒå¥‘çº¦ä¸€è‡´
- [x] **ä¾èµ–è§£è€¦**ï¼šâœ… é€šè¿‡ `CitationRepo` æ¥å£è§£è€¦

### C. æµ‹è¯•è¦†ç›–å®¡æŸ¥

#### C1. æµ‹è¯•å®Œæ•´æ€§
- [x] **å•å…ƒæµ‹è¯•**ï¼šâœ… æœåŠ¡å±‚é€»è¾‘åœ¨é›†æˆæµ‹è¯•ä¸­è¦†ç›–
- [x] **é›†æˆæµ‹è¯•**ï¼šâœ… 2 ä¸ªé›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒåœºæ™¯
- [x] **å¥‘çº¦æµ‹è¯•**ï¼šâœ… å“åº”ç»è¿‡ `EvidenceSchema.parse` éªŒè¯
- [x] **E2E æµ‹è¯•**ï¼šN/Aï¼ˆé›†æˆæµ‹è¯•å·²è¦†ç›–ç«¯åˆ°ç«¯æµç¨‹ï¼‰

#### C2. æµ‹è¯•è´¨é‡
- [x] **Happy Path**ï¼šâœ… è¦†ç›–æ­£å¸¸æµç¨‹ï¼ˆé€šè¿‡ retrieve è·å– citation å†æŸ¥è¯¢ evidenceï¼‰
- [x] **é”™è¯¯åˆ†æ”¯**ï¼šâœ… è¦†ç›–è·¨ projectId é”™è¯¯åœºæ™¯
- [x] **è¾¹ç•Œæ¡ä»¶**ï¼šâœ… è¦†ç›–ä¸å¯å›æºåœºæ™¯ï¼ˆcitationId ä¸å­˜åœ¨ï¼‰
- [x] **å¹¶å‘å®‰å…¨**ï¼šN/Aï¼ˆæ— å¹¶å‘åœºæ™¯ï¼‰

#### C3. æµ‹è¯•å¯ç»´æŠ¤æ€§
- [x] **æµ‹è¯•æ•°æ®**ï¼šâœ… ä½¿ç”¨ mock RAGFlow client å’Œ evidence store
- [x] **æµ‹è¯•éš”ç¦»**ï¼šâœ… æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹åˆ›å»º server å®ä¾‹
- [x] **æµ‹è¯•å‘½å**ï¼šâœ… æµ‹è¯•ç”¨ä¾‹åç§°æ¸…æ™°æè¿°æ„å›¾
- [x] **æ–­è¨€æ¸…æ™°**ï¼šâœ… æ–­è¨€æ˜ç¡®ï¼Œå¤±è´¥æ—¶æœ‰æ¸…æ™°é”™è¯¯æ¶ˆæ¯

### D. æ–‡æ¡£å®¡æŸ¥

#### D1. ä»£ç æ–‡æ¡£
- [x] **å‡½æ•°æ–‡æ¡£**ï¼šğŸŸ¡ æ ¸å¿ƒå‡½æ•°ç¼ºå°‘ JSDocï¼ˆè§ä¼˜åŒ–å»ºè®® 2ï¼‰
- [x] **ç±»å‹æ–‡æ¡£**ï¼šâœ… ç±»å‹å®šä¹‰æ¸…æ™°
- [x] **æ¨¡å—æ–‡æ¡£**ï¼šâœ… æ–‡ä»¶ç»“æ„æ¸…æ™°

#### D2. è®¾è®¡æ–‡æ¡£
- [x] **è®¾è®¡åŒæ­¥**ï¼šâœ… å®ç°ä¸è®¾è®¡æ–‡æ¡£ä¸€è‡´
- [x] **å˜æ›´è®°å½•**ï¼šâœ… æ— åç¦»è®¾è®¡
- [x] **æ¶æ„å›¾**ï¼šN/Aï¼ˆæ— æ¶æ„å˜æ›´ï¼‰

#### D3. ç”¨æˆ·æ–‡æ¡£
- [x] **API æ–‡æ¡£**ï¼šâœ… å¥‘çº¦æ–‡æ¡£ä¸­æœ‰ Evidence Endpoint è¯´æ˜
- [x] **é…ç½®æ–‡æ¡£**ï¼šN/Aï¼ˆæ— æ–°å¢é…ç½®ï¼‰
- [x] **é”™è¯¯æ–‡æ¡£**ï¼šâœ… é”™è¯¯ç åœ¨ `design-contracts.md` ä¸­æœ‰è¯´æ˜

### E. å¯è§‚æµ‹æ€§å®¡æŸ¥

#### E1. æ—¥å¿—
- [x] **å…³é”®è·¯å¾„æ—¥å¿—**ï¼šâœ… API å±‚æœ‰ `evidence_failed` æ—¥å¿—
- [x] **æ—¥å¿—çº§åˆ«**ï¼šâœ… ä½¿ç”¨ `warn` çº§åˆ«è®°å½•å¤±è´¥
- [x] **æ—¥å¿—å†…å®¹**ï¼šâœ… åŒ…å« requestId å’Œ error å¯¹è±¡
- [x] **æ•æ„Ÿæ•°æ®**ï¼šâœ… æ— æ•æ„Ÿæ•°æ®æ³„éœ²

#### E2. Metrics
- [x] **æ€§èƒ½æŒ‡æ ‡**ï¼šN/Aï¼ˆå½“å‰é˜¶æ®µæœªè¦æ±‚ï¼‰
- [x] **ä¸šåŠ¡æŒ‡æ ‡**ï¼šN/Aï¼ˆå½“å‰é˜¶æ®µæœªè¦æ±‚ï¼‰
- [x] **é”™è¯¯ç‡**ï¼šâœ… é€šè¿‡æ—¥å¿—å¯è¿½è¸ªé”™è¯¯

#### E3. è¿½è¸ª
- [x] **requestId è´¯ç©¿**ï¼šâœ… requestId åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¼ é€’
- [x] **ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šâœ… tenantId/projectId æ­£ç¡®ä¼ é€’
- [x] **è°ƒç”¨é“¾**ï¼šâœ… å¯é€šè¿‡ requestId è¿½è¸ªå®Œæ•´è°ƒç”¨é“¾

### F. æ€§èƒ½ä¸èµ„æºå®¡æŸ¥

#### F1. æ€§èƒ½
- [x] **æ—¶é—´å¤æ‚åº¦**ï¼šâœ… O(1) æŸ¥è¯¢ï¼ˆin-memory storeï¼‰
- [x] **ç©ºé—´å¤æ‚åº¦**ï¼šâœ… æ— å†…å­˜æ³„æ¼é£é™©
- [x] **æ•°æ®åº“æŸ¥è¯¢**ï¼šN/Aï¼ˆä½¿ç”¨ in-memory storeï¼‰
- [x] **ç¼“å­˜ç­–ç•¥**ï¼šN/Aï¼ˆå½“å‰é˜¶æ®µæœªè¦æ±‚ï¼‰

#### F2. èµ„æºç®¡ç†
- [x] **è¿æ¥ç®¡ç†**ï¼šN/Aï¼ˆæ— å¤–éƒ¨è¿æ¥ï¼‰
- [x] **æ–‡ä»¶å¥æŸ„**ï¼šN/Aï¼ˆæ— æ–‡ä»¶æ“ä½œï¼‰
- [x] **å†…å­˜ç®¡ç†**ï¼šâœ… æ— å¤§å¯¹è±¡é•¿æœŸæŒæœ‰

### G. ä¾èµ–ä¸é…ç½®å®¡æŸ¥

#### G1. ä¾èµ–ç®¡ç†
- [x] **ä¾èµ–å¿…è¦æ€§**ï¼šâœ… æ— æ–°å¢ä¾èµ–
- [x] **ä¾èµ–ç‰ˆæœ¬**ï¼šN/A
- [x] **ä¾èµ–è®¸å¯**ï¼šN/A
- [x] **ä¾èµ–ç»´æŠ¤æ€§**ï¼šN/A

#### G2. é…ç½®ç®¡ç†
- [x] **é…ç½®å¤–éƒ¨åŒ–**ï¼šN/Aï¼ˆæ— æ–°å¢é…ç½®ï¼‰
- [x] **é…ç½®æ ¡éªŒ**ï¼šN/A
- [x] **é…ç½®æ–‡æ¡£**ï¼šN/A
- [x] **æ•æ„Ÿé…ç½®**ï¼šN/A

### H. ä»»åŠ¡éªŒæ”¶å®¡æŸ¥

#### H1. ä»»åŠ¡å®Œæˆåº¦
- [x] **Checklist å®Œæˆ**ï¼šâœ… æ‰€æœ‰ Checklist é¡¹å·²å®Œæˆ
- [x] **äº§å‡ºç‰©é½å…¨**ï¼šâœ… æ‰€æœ‰äº§å‡ºç‰©å·²äº¤ä»˜
- [x] **éªŒè¯é€šè¿‡**ï¼šâœ… æ‰€æœ‰éªŒè¯æ–­è¨€é€šè¿‡

#### H2. è‡ªåŠ¨åŒ–éªŒè¯
- [x] **æµ‹è¯•é€šè¿‡**ï¼šâœ… `npm run test` é€šè¿‡ï¼ˆ15/15 tests passedï¼‰
- [x] **ç±»å‹æ£€æŸ¥**ï¼šâœ… `npm run typecheck` é€šè¿‡
- [x] **ä»£ç æ£€æŸ¥**ï¼šâœ… `npm run lint` é€šè¿‡
- [x] **æ„å»ºæˆåŠŸ**ï¼šâœ… `npm run build` æˆåŠŸ

#### H3. éªŒæ”¶æ—¥å¿—
- [x] **æ—¥å¿—ç”Ÿæˆ**ï¼šæœ¬æŠ¥å‘Šå³ä¸ºéªŒæ”¶æ—¥å¿—
- [x] **æ—¥å¿—å®Œæ•´**ï¼šâœ… åŒ…å«ä»»åŠ¡ç¼–å·ã€éªŒè¯ç»“æœã€é—®é¢˜æ¸…å•
- [x] **æ—¥å¿—å‘½å**ï¼šâœ… ç¬¦åˆè§„èŒƒ `reports/2025-12-23_T11_evidence-api-review.md`

## éªŒæ”¶å»ºè®®

### å½“å‰çŠ¶æ€
- [x] å¯ä»¥æ ‡è®°ä»»åŠ¡å®Œæˆ
- [ ] éœ€è¦ä¿®å¤é˜»æ–­æ€§é—®é¢˜åå†éªŒæ”¶
- [ ] éœ€è¦è¡¥å……ä¸¥é‡é—®é¢˜çš„é£é™©è¯´æ˜

### ä¿®å¤ä¼˜å…ˆçº§
æ— éœ€ä¿®å¤çš„é˜»æ–­æ€§æˆ–ä¸¥é‡é—®é¢˜ã€‚ä¼˜åŒ–å»ºè®®å¯åœ¨åç»­è¿­ä»£ä¸­å¤„ç†ã€‚

### é£é™©è¯„ä¼°
- **é«˜é£é™©**ï¼šæ— 
- **ä¸­é£é™©**ï¼šæ— 
- **ä½é£é™©**ï¼šæµ‹è¯•è¦†ç›–å¯è¿›ä¸€æ­¥å¢å¼ºï¼ˆè§ä¼˜åŒ–å»ºè®® 1ï¼‰

## äº§å‡ºç‰©éªŒè¯

### 1. Evidence API å¥‘çº¦ï¼ˆZodï¼‰
âœ… **å·²å®Œæˆ**
- æ–‡ä»¶ï¼š`packages/core/src/contracts/evidence.ts`
- å†…å®¹ï¼šå¤ç”¨ `CitationSchema` ä½œä¸º `EvidenceSchema`
- éªŒè¯ï¼šå“åº”å¯è¢« `EvidenceSchema.parse` è§£æ

### 2. citationId å›æºä¸æŸ¥è¯¢æŠ½è±¡
âœ… **å·²å®Œæˆ**
- æ–‡ä»¶ï¼š
  - `packages/core/src/repos/citation-repo.ts`ï¼ˆrepo æ¥å£ä¸å®ç°ï¼‰
  - `packages/core/src/services/evidence-service.ts`ï¼ˆæœåŠ¡å±‚ï¼‰
- å†…å®¹ï¼š
  - `CitationRepo` æ¥å£å®šä¹‰æ¸…æ™°ï¼Œå¯æ›¿æ¢ä¸º DB å®ç°
  - `getEvidenceByCitationId` å®ç°å®Œæ•´
  - å›æºå¤±è´¥è¿”å› `status=unavailable`

### 3. éš”ç¦»æ ¡éªŒ
âœ… **å·²å®Œæˆ**
- æ–‡ä»¶ï¼š
  - `apps/api/src/main.ts`ï¼ˆAPI å±‚æ ¡éªŒï¼‰
  - `packages/core/src/services/evidence-service.ts`ï¼ˆæœåŠ¡å±‚æ ¡éªŒï¼‰
- å†…å®¹ï¼š
  - projectId å¿…é¡»å­˜åœ¨ï¼ˆåœ¨ `requiresProjectId` ä¸­å¼ºåˆ¶ï¼‰
  - tenantId/projectId åŒé‡æ ¡éªŒï¼ˆragflow citationId è§£æ + repo è®°å½•æ ¡éªŒï¼‰
  - è·¨ projectId è¿”å› `AUTH_ERROR`

### 4. é”™è¯¯ä¸é™çº§ç­–ç•¥
âœ… **å·²å®Œæˆ**
- æ–‡ä»¶ï¼š`packages/core/src/services/evidence-service.ts`
- å†…å®¹ï¼š
  - æ— æ•ˆ citationIdï¼š`VALIDATION_ERROR`
  - ç¼ºå¤± projectIdï¼š`AUTH_ERROR`
  - tenantId/projectId ä¸åŒ¹é…ï¼š`AUTH_ERROR`
  - å›æºå¤±è´¥ï¼š`status=unavailable`
- éªŒè¯ï¼šæ‰€æœ‰é”™è¯¯ message ä¸ºè‹±æ–‡ä¸”åŒ…å« requestId

### 5. æµ‹è¯•
âœ… **å·²å®Œæˆ**
- æ–‡ä»¶ï¼š`apps/api/src/evidence.test.ts`
- å†…å®¹ï¼š
  - é›†æˆæµ‹è¯• 1ï¼šè·¨ projectId è¿”å› `AUTH_ERROR`ï¼ˆå« requestIdï¼‰
  - é›†æˆæµ‹è¯• 2ï¼šä¸å¯å›æºè¿”å› `status=unavailable`ï¼ˆsnippet ä¸ºç©ºï¼‰
- éªŒè¯ï¼šæ‰€æœ‰æ–­è¨€é€šè¿‡

### è¯·æ±‚/å“åº”ç¤ºä¾‹

#### æˆåŠŸåœºæ™¯ï¼ˆverifiableï¼‰
GET /api/evidence?citationId=ragflow:tenant_test:proj_a:chunk_123 Headers: x-request-id: req_evidence_1 x-tenant-id: tenant_test x-project-id: proj_a

Response 200: { "citationId": "ragflow:tenant_test:proj_a:chunk_123", "sourceType": "ragflow_chunk", "projectId": "proj_a", "locator": { "page": 5, "offsetStart": 100, "offsetEnd": 200 }, "snippet": "This is the evidence text...", "status": "verifiable" }


#### é™çº§åœºæ™¯ï¼ˆunavailableï¼‰
GET /api/evidence?citationId=c_missing Headers: x-request-id: req_evidence_unavailable_1 x-tenant-id: tenant_test x-project-id: proj_test

Response 200: { "citationId": "c_missing", "sourceType": "document", "projectId": "proj_test", "locator": {}, "status": "unavailable", "degradedReason": "Citation record not found in repository" }


#### é”™è¯¯åœºæ™¯ï¼ˆè·¨ projectIdï¼‰
GET /api/evidence?citationId=ragflow:tenant_test:proj_a:chunk_123 Headers: x-request-id: req_evidence_cross_project_1 x-tenant-id: tenant_test x-project-id: proj_b

Response 401: { "code": "AUTH_ERROR", "message": "projectId mismatch (requestId=req_evidence_cross_project_1)", "retryable": false, "requestId": "req_evidence_cross_project_1", "details": { "expectedProjectId": "proj_b", "actualProjectId": "proj_a" } }



## é™„å½•

### æ£€æŸ¥æ¸…å•
- [x] ä»£ç è´¨é‡å®¡æŸ¥ï¼ˆAï¼‰
- [x] å¥‘çº¦ä¸€è‡´æ€§å®¡æŸ¥ï¼ˆBï¼‰
- [x] æµ‹è¯•è¦†ç›–å®¡æŸ¥ï¼ˆCï¼‰
- [x] æ–‡æ¡£å®¡æŸ¥ï¼ˆDï¼‰
- [x] å¯è§‚æµ‹æ€§å®¡æŸ¥ï¼ˆEï¼‰
- [x] æ€§èƒ½ä¸èµ„æºå®¡æŸ¥ï¼ˆFï¼‰
- [x] ä¾èµ–ä¸é…ç½®å®¡æŸ¥ï¼ˆGï¼‰
- [x] ä»»åŠ¡éªŒæ”¶å®¡æŸ¥ï¼ˆHï¼‰

### å®¡æŸ¥å·¥å…·
- TypeScript Compiler: v5.xï¼ˆä» package.json æ¨æ–­ï¼‰
- ESLint: å·²é…ç½®
- Test Runner: Vitest v2.1.9
- Coverage: 15/15 tests passed (100%)

### å‚è€ƒæ–‡æ¡£
- AGENTS.md
- specs/study-copilot/requirements.md (R21, R41, R10)
- specs/study-copilot/tasks.md (T11)
- specs/study-copilot/design/design-contracts.md (Evidence Endpoint)
- specs/study-copilot/design/design-backend.md

## ç»“è®º

**T11 - Evidence API ä»»åŠ¡å·²æˆåŠŸå®Œæˆï¼Œå¯ä»¥æ ‡è®°ä¸ºå®ŒæˆçŠ¶æ€ âœ…**

### æ ¸å¿ƒæˆå°±
1. âœ… Evidence API å¥‘çº¦å®šä¹‰å®Œæ•´ä¸”ç¬¦åˆè®¾è®¡
2. âœ… citationId å›æºæŠ½è±¡æ¸…æ™°ï¼Œå¯æ›¿æ¢ä¸º DB å®ç°
3. âœ… tenantId/projectId éš”ç¦»æ ¡éªŒå®Œæ•´ï¼Œè·¨é¡¹ç›®è®¿é—®è¢«æ­£ç¡®æ‹’ç»
4. âœ… é™çº§ç­–ç•¥å®Œå–„ï¼Œä¸å¯å›æºæ—¶è¿”å› `status=unavailable` è€Œéä¼ªé€ æ•°æ®
5. âœ… é”™è¯¯å¤„ç†ç»Ÿä¸€ï¼Œæ‰€æœ‰é”™è¯¯ä¸ºè‹±æ–‡ä¸”åŒ…å« requestId
6. âœ… é›†æˆæµ‹è¯•è¦†ç›–æ ¸å¿ƒåœºæ™¯ï¼Œæ‰€æœ‰è‡ªåŠ¨åŒ–éªŒè¯é€šè¿‡
7. âœ… TypeScript Strict æ—  `any`ï¼Œæ‰€æœ‰è¾“å…¥è¾“å‡ºç»è¿‡ Zod æ ¡éªŒ

### è´¨é‡è¯„ä»·
- **ä»£ç è´¨é‡**ï¼šä¼˜ç§€ï¼ˆæ—  `any`ï¼Œç±»å‹å®Œæ•´ï¼Œé”™è¯¯å¤„ç†è§„èŒƒï¼‰
- **å¥‘çº¦ä¸€è‡´æ€§**ï¼šä¼˜ç§€ï¼ˆä¸è®¾è®¡æ–‡æ¡£å®Œå…¨ä¸€è‡´ï¼‰
- **æµ‹è¯•è¦†ç›–**ï¼šè‰¯å¥½ï¼ˆæ ¸å¿ƒåœºæ™¯è¦†ç›–ï¼Œå¯è¿›ä¸€æ­¥å¢å¼ºè¾¹ç•Œæµ‹è¯•ï¼‰
- **å¯è§‚æµ‹æ€§**ï¼šè‰¯å¥½ï¼ˆrequestId è´¯ç©¿ï¼Œæ—¥å¿—å®Œæ•´ï¼‰
- **å®‰å…¨æ€§**ï¼šä¼˜ç§€ï¼ˆéš”ç¦»æ ¡éªŒå®Œæ•´ï¼Œæ— æ•°æ®æ³„éœ²é£é™©ï¼‰

### åç»­å»ºè®®
1. å¯åœ¨åç»­è¿­ä»£ä¸­è¡¥å……æ›´å¤šè¾¹ç•Œæµ‹è¯•ç”¨ä¾‹ï¼ˆè§ä¼˜åŒ–å»ºè®® 1ï¼‰
2. å¯ä¸ºæ ¸å¿ƒæœåŠ¡å‡½æ•°æ·»åŠ  JSDoc æ³¨é‡Šï¼ˆè§ä¼˜åŒ–å»ºè®® 2ï¼‰
3. å½“éœ€è¦æŒä¹…åŒ–æ—¶ï¼Œå¯ç›´æ¥æ›¿æ¢ `CitationRepo` å®ç°ä¸º DB ç‰ˆæœ¬