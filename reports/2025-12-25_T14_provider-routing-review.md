# ä»£ç å®¡æŸ¥æŠ¥å‘Š - T14 Provider Routing

## å®¡æŸ¥æ¦‚è¦
- å®¡æŸ¥æ—¶é—´ï¼š2025-12-25
- ä»»åŠ¡ç¼–å·ï¼šT14
- å®¡æŸ¥èŒƒå›´ï¼šProvider æ¥å£ã€è·¯ç”±ç­–ç•¥ã€æŒ‡æ ‡é‡‡é›†ã€é›†æˆæµ‹è¯•
- å®¡æŸ¥ç»“æœï¼š**æœ‰æ¡ä»¶é€šè¿‡**ï¼ˆéœ€ä¿®å¤ 1 ä¸ªä¸¥é‡é—®é¢˜ï¼‰

## é—®é¢˜æ¸…å•

### ğŸŸ  ä¸¥é‡é—®é¢˜ï¼ˆ1ï¼‰

#### 1. ç¼ºå°‘å®é™… Provider å®ç°ï¼Œä»…æœ‰ Mock
- **ä½ç½®**ï¼š`packages/core/src/providers/`
- **åŸå› **ï¼šä»»åŠ¡ Checklist è¦æ±‚"è‡³å°‘ 1 ä¸ª provider å®ç°å¯ç”¨ï¼ˆå¯å…ˆ mockï¼‰"ï¼Œä½†å½“å‰åªæœ‰ `MockProviderAdapter`ï¼Œæ²¡æœ‰ä»»ä½•çœŸå®çš„ provider å®ç°ï¼ˆå¦‚ OpenAIã€Anthropic ç­‰ï¼‰
- **å½±å“**ï¼š
  - æ— æ³•éªŒè¯çœŸå®åœºæ™¯ä¸‹çš„ provider åˆ‡æ¢
  - æ— æ³•éªŒè¯çœŸå® SDK çš„é”™è¯¯å¤„ç†ä¸ token è®¡æ•°
  - æ— æ³•ç«¯åˆ°ç«¯éªŒè¯è·¯ç”±ç­–ç•¥çš„å®é™…æ•ˆæœ
- **å»ºè®®**ï¼š
  - è‡³å°‘å®ç° 1 ä¸ªçœŸå® provider adapterï¼ˆå»ºè®® OpenAIï¼Œå› ä¸ºæœ€å¸¸ç”¨ï¼‰
  - æˆ–åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜"å½“å‰ä¸º Mock å®ç°ï¼ŒçœŸå® provider å°†åœ¨åç»­ä»»åŠ¡ä¸­è¡¥å……"
  - è¡¥å……çœŸå® provider çš„é›†æˆæµ‹è¯•ç”¨ä¾‹

### ğŸŸ¡ ä¸€èˆ¬é—®é¢˜ï¼ˆ3ï¼‰

#### 2. è·¯ç”±å†³ç­–çš„ç¡®å®šæ€§æµ‹è¯•è¦†ç›–ä¸è¶³
- **ä½ç½®**ï¼š`packages/core/src/providers/provider-routing.test.ts:113-119`
- **åŸå› **ï¼šè™½ç„¶æµ‹è¯•éªŒè¯äº†"åŒé…ç½®åŒè¾“å…¥åŒè¾“å‡º"ï¼Œä½†åªæµ‹è¯•äº† 2 æ¬¡è°ƒç”¨ï¼Œä¸”æ²¡æœ‰æµ‹è¯•ä¸åŒè¾“å…¥ï¼ˆå¦‚ä¸åŒ prompt é•¿åº¦ï¼‰ä¸‹çš„è·¯ç”±å†³ç­–
- **å½±å“**ï¼šæ— æ³•å……åˆ†éªŒè¯è·¯ç”±å†³ç­–çš„ç¡®å®šæ€§ï¼ˆdeterministicï¼‰è¦æ±‚
- **å»ºè®®**ï¼š
  - å¢åŠ æµ‹è¯•ç”¨ä¾‹ï¼šç›¸åŒé…ç½® + ä¸åŒ prompt é•¿åº¦ -> éªŒè¯å¯å‘å¼è·¯ç”±çš„ç¡®å®šæ€§
  - å¢åŠ æµ‹è¯•ç”¨ä¾‹ï¼šç›¸åŒé…ç½® + ç›¸åŒ hint -> éªŒè¯ hint è·¯ç”±çš„ç¡®å®šæ€§

#### 3. ç¼ºå°‘ streaming åœºæ™¯çš„ fallback æµ‹è¯•
- **ä½ç½®**ï¼š`packages/core/src/providers/provider-routing.test.ts`
- **åŸå› **ï¼šå½“å‰æµ‹è¯•åªè¦†ç›–äº† `generateText` çš„ fallbackï¼Œæ²¡æœ‰æµ‹è¯• `streamText` çš„ fallback åœºæ™¯
- **å½±å“**ï¼šæ— æ³•éªŒè¯ streaming åœºæ™¯ä¸‹çš„é™çº§ç­–ç•¥æ˜¯å¦æ­£ç¡®
- **å»ºè®®**ï¼š
  - å¢åŠ æµ‹è¯•ç”¨ä¾‹ï¼šprimary provider çš„ `streamText` å¤±è´¥ -> fallback åˆ° `generateText`
  - å¢åŠ æµ‹è¯•ç”¨ä¾‹ï¼šæ‰€æœ‰ provider çš„ `streamText` éƒ½ä¸å¯ç”¨ -> é™çº§åˆ° `generateText`

#### 4. æŒ‡æ ‡é‡‡é›†ç¼ºå°‘ token ç”¨é‡çš„å®é™…éªŒè¯
- **ä½ç½®**ï¼š`packages/core/src/providers/metrics.ts`ã€`packages/core/src/providers/routed-language-model.ts`
- **åŸå› **ï¼šè™½ç„¶å®šä¹‰äº† `TokenUsage` ç±»å‹å’ŒæŒ‡æ ‡è®°å½•é€»è¾‘ï¼Œä½†æµ‹è¯•ä¸­æ²¡æœ‰éªŒè¯ token ç”¨é‡æ˜¯å¦æ­£ç¡®è®°å½•
- **å½±å“**ï¼šæ— æ³•ç¡®ä¿æˆæœ¬è¿½è¸ªåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- **å»ºè®®**ï¼š
  - åœ¨ `MockProviderAdapter` ä¸­æ”¯æŒè¿”å› mock çš„ token usage
  - å¢åŠ æµ‹è¯•ç”¨ä¾‹ï¼šéªŒè¯ metrics.record è¢«è°ƒç”¨æ—¶åŒ…å«æ­£ç¡®çš„ usage å­—æ®µ

### ğŸŸ¢ ä¼˜åŒ–å»ºè®®ï¼ˆ4ï¼‰

#### 5. è·¯ç”±é…ç½®æ ¡éªŒé”™è¯¯æ¶ˆæ¯å¯ä»¥æ›´å‹å¥½
- **ä½ç½®**ï¼š`packages/core/src/providers/router.ts:31-39`
- **åŸå› **ï¼šä½¿ç”¨ Zod çš„é»˜è®¤é”™è¯¯æ¶ˆæ¯ï¼Œå¯¹äºé…ç½®é”™è¯¯çš„å®šä½ä¸å¤Ÿå‹å¥½
- **å»ºè®®**ï¼šä½¿ç”¨ Zod çš„ `.refine()` æˆ–è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼Œæä¾›æ›´æ¸…æ™°çš„é…ç½®é”™è¯¯æç¤º

#### 6. å¯ä»¥å¢åŠ è·¯ç”±ç­–ç•¥çš„å¯è§‚æµ‹æ€§
- **ä½ç½®**ï¼š`packages/core/src/providers/router.ts:decideProviderRoute`
- **åŸå› **ï¼šå½“å‰åªè®°å½•äº†æœ€ç»ˆå†³ç­–ï¼Œæ²¡æœ‰è®°å½•å†³ç­–è¿‡ç¨‹ï¼ˆå¦‚ä¸ºä»€ä¹ˆé€‰æ‹©äº†æŸä¸ªè·¯ç”±ï¼‰
- **å»ºè®®**ï¼š
  - åœ¨ `RouteDecision` ä¸­å¢åŠ  `metadata` å­—æ®µï¼Œè®°å½•å†³ç­–ä¾æ®ï¼ˆå¦‚ prompt é•¿åº¦ã€hint å€¼ç­‰ï¼‰
  - åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ›´è¯¦ç»†çš„å†³ç­–ä¿¡æ¯

#### 7. å¯ä»¥æ”¯æŒæ›´çµæ´»çš„ fallback ç­–ç•¥
- **ä½ç½®**ï¼š`packages/core/src/providers/routed-language-model.ts:generateTextWithFallbackDetails`
- **åŸå› **ï¼šå½“å‰ fallback æ˜¯çº¿æ€§éå†ï¼Œæ²¡æœ‰æ”¯æŒæ›´å¤æ‚çš„ç­–ç•¥ï¼ˆå¦‚è·³è¿‡æŸäº› providerã€é‡è¯•æ¬¡æ•°é™åˆ¶ç­‰ï¼‰
- **å»ºè®®**ï¼š
  - åœ¨ `ProviderRoutingConfig` ä¸­å¢åŠ  `fallbackPolicy` é…ç½®ï¼ˆå¦‚ `maxRetries`ã€`skipProviders` ç­‰ï¼‰
  - åœ¨åç»­ä»»åŠ¡ä¸­æ‰©å±•ï¼ˆä¸é˜»å¡å½“å‰ä»»åŠ¡ï¼‰

#### 8. å¯ä»¥å¢åŠ é…ç½®ç¤ºä¾‹æ–‡æ¡£
- **ä½ç½®**ï¼šæ–‡æ¡£ç¼ºå¤±
- **åŸå› **ï¼šä»»åŠ¡ Output è¦æ±‚"è·¯ç”±ç­–ç•¥è¯´æ˜ + é…ç½®ç¤ºä¾‹"ï¼Œä½†å½“å‰æ²¡æœ‰ç‹¬ç«‹çš„é…ç½®æ–‡æ¡£
- **å»ºè®®**ï¼š
  - åœ¨ `packages/core/src/providers/README.md` ä¸­è¡¥å……é…ç½®ç¤ºä¾‹
  - åŒ…å«ï¼šåŸºç¡€é…ç½®ã€å¯å‘å¼è·¯ç”±é…ç½®ã€hint ä½¿ç”¨ç¤ºä¾‹

## å®¡æŸ¥ç»´åº¦è¯¦æƒ…

### A. ä»£ç è´¨é‡å®¡æŸ¥
- [x] **TypeScript ä¸¥æ ¼æ€§**ï¼šé€šè¿‡
  - æ‰€æœ‰æ–‡ä»¶æ—  `any` ç±»å‹
  - ç±»å‹å®šä¹‰å®Œæ•´ä¸”å‡†ç¡®
  - æ³›å‹çº¦æŸåˆç†ï¼ˆ`TContext extends RequestContext`ï¼‰
- [x] **Zod æ ¡éªŒ**ï¼šé€šè¿‡
  - è·¯ç”±é…ç½®ä½¿ç”¨ Zod æ ¡éªŒï¼ˆ`ProviderRoutingConfigSchema`ï¼‰
  - è·¯ç”± hint ä½¿ç”¨ Zod æ ¡éªŒï¼ˆ`ProviderRoutingHintSchema`ï¼‰
  - æ ¡éªŒå¤±è´¥ä¼šæŠ›å‡º Zod é”™è¯¯ï¼ˆåŒ…å«å­—æ®µä¿¡æ¯ï¼‰
- [x] **é”™è¯¯å¤„ç†**ï¼šé€šè¿‡
  - é”™è¯¯æ¶ˆæ¯ä½¿ç”¨è‹±æ–‡
  - é”™è¯¯æ­£ç¡®ä¼ æ’­ï¼ˆä¸åå™¬å¼‚å¸¸ï¼‰
  - fallback ç­–ç•¥æ¸…æ™°
- [x] **ä»£ç é£æ ¼ä¸å¯ç»´æŠ¤æ€§**ï¼šé€šè¿‡
  - å‘½åæ¸…æ™°ä¸€è‡´
  - å‡½æ•°å¤æ‚åº¦åˆç†
  - å…³é”®é€»è¾‘æœ‰æ³¨é‡Šï¼ˆå¦‚ fallback é€»è¾‘ï¼‰
- [x] **å®‰å…¨æ€§**ï¼šé€šè¿‡
  - æ— æ˜æ˜¾å®‰å…¨æ¼æ´
  - è¾“å…¥ç»è¿‡ Zod æ ¡éªŒ

### B. å¥‘çº¦ä¸€è‡´æ€§å®¡æŸ¥
- [x] **Schema å®šä¹‰**ï¼šé€šè¿‡
  - `ProviderAdapter` æ¥å£å®šä¹‰æ¸…æ™°
  - `ProviderRoute`ã€`ProviderRoutingConfig` æœ‰ Zod schema
- [x] **å¥‘çº¦ä½¿ç”¨ä¸€è‡´æ€§**ï¼šé€šè¿‡
  - `LanguageModel` æ¥å£ä¸ `ProviderAdapter` æ¥å£å¯¹é½
  - è¾“å…¥è¾“å‡ºç±»å‹ä¸€è‡´
- [x] **è·¨æ¨¡å—å¥‘çº¦**ï¼šé€šè¿‡
  - é€šè¿‡ `RequestContext` å®ç°æ¨¡å—è§£è€¦
  - é€šè¿‡ `Logger` å’Œ `ProviderMetricsSink` æ¥å£å®ç°ä¾èµ–æ³¨å…¥

### C. æµ‹è¯•è¦†ç›–å®¡æŸ¥
- [x] **å•å…ƒæµ‹è¯•**ï¼šé€šè¿‡
  - è·¯ç”±å†³ç­–é€»è¾‘æœ‰å•å…ƒæµ‹è¯•ï¼ˆéšå«åœ¨é›†æˆæµ‹è¯•ä¸­ï¼‰
- [x] **é›†æˆæµ‹è¯•**ï¼šéƒ¨åˆ†é€šè¿‡
  - âœ… åˆ‡æ¢é…ç½®ç”Ÿæ•ˆï¼ˆæµ‹è¯• 1ï¼‰
  - âœ… fallback ç”Ÿæ•ˆï¼ˆæµ‹è¯• 2ï¼‰
  - âœ… æ—¥å¿—åŒ…å« requestId/taskId/providerId/modelIdï¼ˆæµ‹è¯• 3ï¼‰
  - âŒ ç¼ºå°‘ streaming fallback æµ‹è¯•
  - âŒ ç¼ºå°‘ token usage éªŒè¯æµ‹è¯•
- [x] **Happy Path**ï¼šé€šè¿‡
  - æµ‹è¯•è¦†ç›–æ­£å¸¸æµç¨‹
- [x] **é”™è¯¯åˆ†æ”¯**ï¼šé€šè¿‡
  - æµ‹è¯•è¦†ç›– provider å¤±è´¥åœºæ™¯
- [ ] **è¾¹ç•Œæ¡ä»¶**ï¼šæœªè¦†ç›–
  - ç¼ºå°‘ç©º providers åˆ—è¡¨çš„æµ‹è¯•
  - ç¼ºå°‘é‡å¤ providerId çš„æµ‹è¯•ï¼ˆè™½ç„¶ä»£ç æœ‰æ£€æŸ¥ï¼‰
  - ç¼ºå°‘æœªçŸ¥ providerId çš„æµ‹è¯•

### D. æ–‡æ¡£å®¡æŸ¥
- [ ] **å‡½æ•°æ–‡æ¡£**ï¼šç¼ºå¤±
  - å…¬å…±å‡½æ•°ç¼ºå°‘ JSDoc æ³¨é‡Š
  - å»ºè®®è‡³å°‘ä¸º `createRoutedLanguageModel` å’Œ `decideProviderRoute` æ·»åŠ  JSDoc
- [ ] **æ¨¡å—æ–‡æ¡£**ï¼šç¼ºå¤±
  - ç¼ºå°‘ `packages/core/src/providers/README.md`
  - ä»»åŠ¡ Output è¦æ±‚"è·¯ç”±ç­–ç•¥è¯´æ˜ + é…ç½®ç¤ºä¾‹"æœªæä¾›
- [x] **ç±»å‹æ–‡æ¡£**ï¼šé€šè¿‡
  - å¤æ‚ç±»å‹æœ‰æ¸…æ™°çš„å‘½å

### E. å¯è§‚æµ‹æ€§å®¡æŸ¥
- [x] **å…³é”®è·¯å¾„æ—¥å¿—**ï¼šé€šè¿‡
  - è·¯ç”±å†³ç­–æœ‰æ—¥å¿—ï¼ˆ`Provider route decided`ï¼‰
  - provider è°ƒç”¨å¼€å§‹/æˆåŠŸ/å¤±è´¥æœ‰æ—¥å¿—
  - streaming å¼€å§‹/ç»“æŸæœ‰æ—¥å¿—
- [x] **æ—¥å¿—çº§åˆ«**ï¼šé€šè¿‡
  - å†³ç­–ä½¿ç”¨ `info`
  - è°ƒè¯•ä¿¡æ¯ä½¿ç”¨ `debug`
  - å¤±è´¥ä½¿ç”¨ `warn`
- [x] **æ—¥å¿—å†…å®¹**ï¼šé€šè¿‡
  - åŒ…å« requestId
  - åŒ…å« taskIdï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  - åŒ…å« providerId/modelId
- [x] **æ•æ„Ÿæ•°æ®**ï¼šé€šè¿‡
  - æ—¥å¿—ä¸è®°å½• prompt å†…å®¹ï¼ˆé¿å…æ³„éœ²ï¼‰
- [x] **Metrics**ï¼šé€šè¿‡
  - è®°å½• durationMs
  - è®°å½• ttftMsï¼ˆstreamingï¼‰
  - è®°å½• success/failure
  - è®°å½• usageï¼ˆå¦‚æœå¯å¾—ï¼‰
  - è®°å½• attemptï¼ˆé‡è¯•æ¬¡æ•°ï¼‰

### F. æ€§èƒ½ä¸èµ„æºå®¡æŸ¥
- [x] **æ—¶é—´å¤æ‚åº¦**ï¼šé€šè¿‡
  - è·¯ç”±å†³ç­– O(1)
  - fallback éå† O(n)ï¼Œn ä¸º candidates æ•°é‡ï¼ˆé€šå¸¸å¾ˆå°ï¼‰
- [x] **ç©ºé—´å¤æ‚åº¦**ï¼šé€šè¿‡
  - æ— æ˜æ˜¾å†…å­˜æ³„æ¼é£é™©
- [x] **èµ„æºç®¡ç†**ï¼šé€šè¿‡
  - streaming ä½¿ç”¨ async generatorï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾

### G. ä¾èµ–ä¸é…ç½®å®¡æŸ¥
- [x] **ä¾èµ–å¿…è¦æ€§**ï¼šé€šè¿‡
  - åªä¾èµ– Zodï¼ˆå·²æœ‰ï¼‰
  - æ— æ–°å¢å¤–éƒ¨ä¾èµ–
- [x] **ä¾èµ–ç‰ˆæœ¬**ï¼šé€šè¿‡
  - Zod ç‰ˆæœ¬å·²é”å®š
- [x] **é…ç½®å¤–éƒ¨åŒ–**ï¼šé€šè¿‡
  - è·¯ç”±é…ç½®é€šè¿‡å‚æ•°ä¼ å…¥
  - æ”¯æŒè¿è¡Œæ—¶é…ç½®
- [x] **é…ç½®æ ¡éªŒ**ï¼šé€šè¿‡
  - ä½¿ç”¨ Zod æ ¡éªŒé…ç½®

### H. ä»»åŠ¡éªŒæ”¶å®¡æŸ¥
- [x] **Checklist å®Œæˆ**ï¼šéƒ¨åˆ†å®Œæˆ
  - [x] ä»£ç ç¼–è¯‘é€šè¿‡ï¼ˆé™æ€åˆ†æé€šè¿‡ï¼‰
  - [?] ç±»å‹æ£€æŸ¥é€šè¿‡ï¼ˆæ— æ³•è¿è¡Œï¼Œä½†ä»£ç ç¬¦åˆ strict æ¨¡å¼ï¼‰
  - [?] Lint æ£€æŸ¥é€šè¿‡ï¼ˆæ— æ³•è¿è¡Œï¼Œä½†ä»£ç é£æ ¼ä¸€è‡´ï¼‰
  - [x] Provider adapter æ¥å£å®Œæˆï¼ˆå¯æ›¿æ¢ï¼‰
  - [x] è‡³å°‘ 1 ä¸ª provider å®ç°å¯ç”¨ï¼ˆMock å®ç°ï¼‰
  - [x] è·¯ç”±ç­–ç•¥å®ç°å®Œæˆï¼ˆæŒ‰é…ç½®/æœ€å°å¯å‘å¼ï¼‰
  - [x] æŒ‡æ ‡/æ—¥å¿—é‡‡é›†å®Œæˆï¼ˆä¸ requestId å…³è”ï¼‰
  - [x] é›†æˆæµ‹è¯•è¦†ç›–ï¼šåˆ‡æ¢ç”Ÿæ•ˆ + fallback
- [ ] **äº§å‡ºç‰©é½å…¨**ï¼šéƒ¨åˆ†é½å…¨
  - [x] Provider æ¥å£ä¸å®ç°æ–‡ä»¶è·¯å¾„ï¼šå·²æä¾›
  - [ ] è·¯ç”±ç­–ç•¥è¯´æ˜ + é…ç½®ç¤ºä¾‹ï¼šç¼ºå¤±ç‹¬ç«‹æ–‡æ¡£
  - [x] æµ‹è¯•æ–‡ä»¶æ¸…å•ä¸æ–­è¨€ç‚¹ï¼šå·²æä¾›
- [ ] **è‡ªåŠ¨åŒ–éªŒè¯**ï¼šæ— æ³•æ‰§è¡Œ
  - ç”±äºç¯å¢ƒé™åˆ¶ï¼Œæ— æ³•è¿è¡Œ `npm run test`ã€`npm run typecheck`ã€`npm run lint`
  - ä½†ä»£ç é™æ€åˆ†ææ˜¾ç¤ºç¬¦åˆè§„èŒƒ

## éªŒæ”¶å»ºè®®

### å½“å‰çŠ¶æ€
- [ ] å¯ä»¥æ ‡è®°ä»»åŠ¡å®Œæˆ
- [x] éœ€è¦è¡¥å……æ–‡æ¡£åå†éªŒæ”¶
- [ ] éœ€è¦ä¿®å¤é˜»æ–­æ€§é—®é¢˜åå†éªŒæ”¶

### ä¿®å¤ä¼˜å…ˆçº§
1. ğŸŸ  è¡¥å……è·¯ç”±ç­–ç•¥è¯´æ˜ä¸é…ç½®ç¤ºä¾‹æ–‡æ¡£ï¼ˆä¸¥é‡ï¼‰
2. ğŸŸ¡ å¢åŠ  streaming fallback æµ‹è¯•ï¼ˆä¸€èˆ¬ï¼‰
3. ğŸŸ¡ å¢åŠ  token usage éªŒè¯æµ‹è¯•ï¼ˆä¸€èˆ¬ï¼‰
4. ğŸŸ¡ å¢åŠ è·¯ç”±å†³ç­–ç¡®å®šæ€§æµ‹è¯•ï¼ˆä¸€èˆ¬ï¼‰
5. ğŸŸ¢ è¡¥å…… JSDoc æ³¨é‡Šï¼ˆä¼˜åŒ–ï¼‰

### é£é™©è¯„ä¼°
- **ä¸­é£é™©**ï¼šç¼ºå°‘çœŸå® provider å®ç°ï¼Œæ— æ³•éªŒè¯çœŸå®åœºæ™¯ä¸‹çš„è¡Œä¸ºå·®å¼‚ï¼ˆå¦‚ token è®¡æ•°ã€é”™è¯¯å½¢æ€ï¼‰
  - ç¼“è§£æªæ–½ï¼šåœ¨åç»­ä»»åŠ¡ä¸­è¡¥å……çœŸå® provider å®ç°ï¼Œå¹¶å¢åŠ é›†æˆæµ‹è¯•
- **ä½é£é™©**ï¼šè·¯ç”±ç­–ç•¥è¾ƒç®€å•ï¼Œå¯èƒ½æ— æ³•æ»¡è¶³å¤æ‚åœºæ™¯éœ€æ±‚
  - ç¼“è§£æªæ–½ï¼šå½“å‰ä¸º"æœ€å°å¯å‘å¼"ï¼Œç¬¦åˆä»»åŠ¡è¦æ±‚ï¼›å¤æ‚ç­–ç•¥å¯åœ¨åç»­è¿­ä»£ä¸­æ‰©å±•

## é™„å½•

### æ£€æŸ¥æ¸…å•
- [x] ä»£ç è´¨é‡å®¡æŸ¥ï¼ˆAï¼‰
- [x] å¥‘çº¦ä¸€è‡´æ€§å®¡æŸ¥ï¼ˆBï¼‰
- [x] æµ‹è¯•è¦†ç›–å®¡æŸ¥ï¼ˆCï¼‰
- [x] æ–‡æ¡£å®¡æŸ¥ï¼ˆDï¼‰
- [x] å¯è§‚æµ‹æ€§å®¡æŸ¥ï¼ˆEï¼‰
- [x] æ€§èƒ½ä¸èµ„æºå®¡æŸ¥ï¼ˆFï¼‰
- [x] ä¾èµ–ä¸é…ç½®å®¡æŸ¥ï¼ˆGï¼‰
- [x] ä»»åŠ¡éªŒæ”¶å®¡æŸ¥ï¼ˆHï¼‰

### äº§å‡ºæ–‡ä»¶æ¸…å•
- `packages/core/src/providers/provider.ts` - Provider æ¥å£å®šä¹‰
- `packages/core/src/providers/router.ts` - è·¯ç”±ç­–ç•¥ä¸å†³ç­–é€»è¾‘
- `packages/core/src/providers/routed-language-model.ts` - è·¯ç”± LanguageModel å®ç°
- `packages/core/src/providers/metrics.ts` - æŒ‡æ ‡é‡‡é›†æ¥å£
- `packages/core/src/providers/mock-provider.ts` - Mock Provider å®ç°
- `packages/core/src/providers/provider-routing.test.ts` - é›†æˆæµ‹è¯•
- `packages/core/src/providers/index.ts` - æ¨¡å—å¯¼å‡º

### æµ‹è¯•æ–­è¨€ç‚¹ï¼ˆå·²å®ç°ï¼‰
1. âœ… åˆ‡æ¢ provider/model é…ç½®åï¼Œè·¯ç”±é€‰æ‹©å‘ç”Ÿå˜åŒ–ä¸”ä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹
2. âœ… ä¸» provider æŠ›é”™ -> fallback provider è¢«è°ƒç”¨ï¼ˆmock/spy æ–­è¨€ï¼‰
3. âœ… è·¯ç”±å†³ç­–æ—¥å¿—åŒ…å« requestId/taskId/provider/model

### æµ‹è¯•æ–­è¨€ç‚¹ï¼ˆå»ºè®®è¡¥å……ï¼‰
4. âš ï¸ streaming åœºæ™¯ä¸‹çš„ fallback ç­–ç•¥
5. âš ï¸ token usage æ­£ç¡®è®°å½•åˆ° metrics
6. âš ï¸ ç›¸åŒé…ç½® + ä¸åŒè¾“å…¥ -> è·¯ç”±å†³ç­–ç¡®å®šæ€§

### é…ç½®ç¤ºä¾‹ï¼ˆå»ºè®®è¡¥å……åˆ°æ–‡æ¡£ï¼‰

```typescript
// åŸºç¡€é…ç½®ï¼šå›ºå®š provider
const basicConfig = {
  routing: {
    primary: { providerId: "openai", modelId: "gpt-4" },
    fallbacks: [
      { providerId: "anthropic", modelId: "claude-3" }
    ]
  },
  providers: [openaiAdapter, anthropicAdapter]
};

// å¯å‘å¼è·¯ç”±ï¼šæŒ‰ prompt é•¿åº¦é€‰æ‹©æ¨¡å‹
const heuristicConfig = {
  routing: {
    primary: { providerId: "openai", modelId: "gpt-4" },
    fallbacks: [],
    heuristic: {
      thresholdChars: 800,
      low: { providerId: "openai", modelId: "gpt-3.5-turbo" },
      high: { providerId: "openai", modelId: "gpt-4" }
    }
  },
  providers: [openaiAdapter]
};

// Hint è·¯ç”±ï¼šæŒ‰ä¸šåŠ¡é€»è¾‘åŠ¨æ€é€‰æ‹©
const hintConfig = {
  routing: {
    primary: { providerId: "openai", modelId: "gpt-4" },
    fallbacks: [],
    heuristic: {
      thresholdChars: 800,
      low: { providerId: "openai", modelId: "gpt-3.5-turbo" },
      high: { providerId: "openai", modelId: "gpt-4" }
    }
  },
  providers: [openaiAdapter],
  hintResolver: (ctx, input) => {
    // ä¸šåŠ¡é€»è¾‘å†³å®šå¤æ‚åº¦
    if (input.prompt.includes("complex")) {
      return { complexity: "high" };
    }
    return { complexity: "low" };
  }
};

```

å‚è€ƒæ–‡æ¡£
AGENTS.md
specs/study-copilot/requirements.md (R14)
specs/study-copilot/tasks.md (T14)
specs/study-copilot/design/design-agent.md
specs/study-copilot/design/design-contracts.md
æ€»ç»“
T14 Provider Routing çš„å®ç°æ•´ä½“è´¨é‡è‰¯å¥½ï¼Œæ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œä»£ç ç¬¦åˆ TypeScript Strict è§„èŒƒï¼Œæµ‹è¯•è¦†ç›–äº†å…³é”®åœºæ™¯ã€‚

ä¸»è¦ä¼˜ç‚¹ï¼š

âœ… æ¥å£è®¾è®¡æ¸…æ™°ï¼Œæ”¯æŒå¯æ›¿æ¢çš„ provider adapter
âœ… è·¯ç”±ç­–ç•¥çµæ´»ï¼Œæ”¯æŒå›ºå®šé…ç½®ã€å¯å‘å¼ã€hint ä¸‰ç§æ¨¡å¼
âœ… å¯è§‚æµ‹æ€§å®Œå–„ï¼Œæ—¥å¿—å’ŒæŒ‡æ ‡é‡‡é›†é½å…¨
âœ… é”™è¯¯å¤„ç†å¥å£®ï¼Œæ”¯æŒ fallback å’Œé‡è¯•
âœ… ç±»å‹å®‰å…¨ï¼Œæ—  any ç±»å‹
éœ€è¦æ”¹è¿›ï¼š

ğŸŸ  ç¼ºå°‘è·¯ç”±ç­–ç•¥è¯´æ˜ä¸é…ç½®ç¤ºä¾‹æ–‡æ¡£ï¼ˆä¸¥é‡ï¼‰
ğŸŸ¡ æµ‹è¯•è¦†ç›–å¯ä»¥æ›´å…¨é¢ï¼ˆstreaming fallbackã€token usageã€è¾¹ç•Œæ¡ä»¶ï¼‰
ğŸŸ¢ å¯ä»¥è¡¥å…… JSDoc æ³¨é‡Šæå‡å¯ç»´æŠ¤æ€§
éªŒæ”¶å»ºè®®ï¼šè¡¥å……æ–‡æ¡£åå¯æ ‡è®°å®Œæˆã€‚çœŸå® provider å®ç°å¯åœ¨åç»­ä»»åŠ¡ä¸­è¡¥å……ï¼ˆä¸é˜»å¡å½“å‰ä»»åŠ¡ï¼‰ã€‚


---

