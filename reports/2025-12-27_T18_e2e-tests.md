# T18 验收日志：端到端测试（模板启动 -> 运行 -> 引用 -> 导出）

- Date: 2025-12-27
- Task: T18

## Scope

- 新增 Node 级 E2E 测试用例（Happy/Cancel/Error-Retry/Isolation）。
- 补齐 Web 侧 e2e-ish：error block + retry。
- 将 `tests/e2e` 纳入根 `npm run test` 验证流程。

## Key Changes

- `tests/e2e/mocks/stream-provider.ts`
  - 对齐 `apps/api` 的 `buildServer({ streamProvider })` 签名，确保类型一致并支持 ctx/prompt/signal/options。

- `tests/e2e/happy-path.test.ts`
  - 覆盖 createTask -> stream -> step events -> citations -> evidence -> export。
  - Step events 使用 `StepEventSchema` 强校验，避免 TS strict 下的隐式 any/unknown。

- `tests/e2e/error-retry.test.ts`
  - 覆盖 provider 失败产生 retryable error，重试后成功完成（finish-message）。

- `tests/e2e/isolation.test.ts`
  - 覆盖跨 projectId evidence 访问必须返回 `AUTH_ERROR` 且包含 requestId。

- `tests/e2e/cancel.test.ts`
  - 覆盖运行中取消：触发 `cancelTask` 后观察 provider abort。
  - 断言策略与 `apps/api/src/stream.test.ts` 对齐：
    - 必须观察到 `abortObserved=true`
    - step events 中不应出现 `step_completed`
    - 若存在 `data-app-error` 则可选校验其为 `CANCELLED`

- `apps/web/src/app.e2e-ish.test.tsx`
  - 新增 error block + retry 用例：首次 stream 返回 `data-app-error`，点击 Retry 后二次运行成功。
  - 修复时序抖动：等待 retry 按钮 `disabled=false` 再点击。

- `package.json`
  - 更新根 `test` 脚本：`turbo run test && vitest run tests/integration && vitest run tests/e2e`

## Verification

已在本地执行以下命令并通过：

- `npm run build` ✅
- `npm run test` ✅
- `npm run typecheck` ✅
- `npm run lint` ✅

## Test Result Summary

Node 级 E2E（`vitest run tests/e2e`）：

- `tests/e2e/happy-path.test.ts`: 2 passed
- `tests/e2e/cancel.test.ts`: 1 passed
- `tests/e2e/error-retry.test.ts`: 1 passed
- `tests/e2e/isolation.test.ts`: 1 passed
- Total: 5 tests passed

Integration（`vitest run tests/integration`）：

- Test Files: 4 passed
- Tests: 8 passed

Web e2e-ish（`apps/web/src/app.e2e-ish.test.tsx`）：

- `export: preview and copy include output and citation metadata`
- `happy path: run -> output increments -> events -> citations -> evidence`
- `cancel: aborts stream and status becomes cancelled`
- `error: shows error block then retry succeeds`
- `responsive layout switches to single column on narrow widths`
- Total: 5 tests defined in this file

## Config Notes

- `tests/e2e/cancel.test.ts` 支持通过环境变量 `E2E_CANCEL_ABORT_TIMEOUT_MS` 调整 abort 等待超时（默认 `2000`）。

## Fixture Versioning Notes

- `tests/e2e/fixtures/*.json` 增加 `schemaVersion` 字段（当前为 `1`）。

## Notes

- Web build 输出包含 Vite CJS Node API deprecation 警告，但不影响本次验收；构建与测试均通过。
